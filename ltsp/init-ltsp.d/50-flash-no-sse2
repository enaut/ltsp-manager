# The latest Adobe Flash Player is compiled with SSE2 instructions,
# and it thus segfaults on older CPUs that don't support SSE2:
# https://bugbase.adobe.com/index.cfm?event=bug&id=3154276
# https://bugs.launchpad.net/ubuntu/+source/flashplugin-nonfree/+bug/968759
#
# As a workaround, if the user has manually downloaded an older Flash version
# that was not compiled with SSE2, use it, while disabling version checking.

if [ -f /usr/lib/flashplugin-installer/libflashplayer-11.1.102.63.so ] &&
    ! grep -qw sse2 /proc/cpuinfo
then
    mv --backup /usr/lib/flashplugin-installer/libflashplayer-11.1.102.63.so \
        /usr/lib/flashplugin-installer/libflashplayer.so
    if [ -d /usr/lib/firefox/defaults/pref ]; then
        cat >/usr/lib/firefox/defaults/pref/flash-no-sse2.js <<EOF
// Automatically generated by /usr/share/ltsp/init-ltsp.d/50-flash-no-sse2
lockPref("extensions.blocklist.enabled", false);
EOF
    fi
fi
